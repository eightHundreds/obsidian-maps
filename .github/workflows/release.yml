name: Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify versions
        shell: bash
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          tag_version="${tag#v}"

          manifest_version="$(node -p "require('./manifest.json').version")"
          if [[ "${tag_version}" != "${manifest_version}" ]]; then
            echo "Tag '${tag}' does not match manifest.json version '${manifest_version}'."
            echo "Create a tag that exactly matches manifest.json's version (recommended: no leading 'v')."
            exit 1
          fi

          package_version="$(node -p "require('./package.json').version")"
          if [[ "${package_version}" != "${manifest_version}" ]]; then
            echo "package.json version '${package_version}' does not match manifest.json version '${manifest_version}'."
            exit 1
          fi

          versions_min_app="$(node -p "require('./versions.json')['${manifest_version}'] || ''")"
          if [[ -z "${versions_min_app}" ]]; then
            echo "versions.json is missing an entry for '${manifest_version}'."
            exit 1
          fi

      - name: Build
        run: npm run build

      - name: Collect release artifacts
        id: artifacts
        shell: bash
        run: |
          set -euo pipefail

          test -f manifest.json
          test -f main.js

          {
            echo "files<<EOF"
            echo "manifest.json"
            echo "main.js"
            if [[ -f styles.css ]]; then
              echo "styles.css"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.artifacts.outputs.files }}
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
